<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worship Lyrics Slideshow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .blur-text {
            filter: blur(1px);
            opacity: 0.8;
        }
        
        .dark .app-container {
            background-color: #181818;
            color: white;
        }
        
        .dark .input-container {
            background-color: #222;
        }
        
        .dark .slideshow-container {
            background-color: #111;
        }
        
        .transition-all {
            transition: all 0.3s ease;
        }
        
        /* Simple, clean transitions */
        .lyrics-line {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="h-full m-0 font-sans bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="app-container h-full flex flex-col">
        <!-- Input view -->
        <div id="inputView" class="flex flex-col h-full p-4">
            <h1 class="text-2xl font-bold text-center mb-4 text-primary dark:text-primary">Worship Lyrics Slideshow</h1>
            
            <div class="input-container bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 flex-grow flex flex-col">
                <label for="lyricsInput" class="block text-sm font-medium mb-2">Paste your lyrics below:</label>
                <textarea 
                    id="lyricsInput" 
                    class="w-full flex-grow p-3 border rounded-md text-base dark:bg-gray-700 dark:border-gray-600 focus:border-primary focus:ring-primary"
                    placeholder="Enter your lyrics here. Each line will be treated as a separate slide."></textarea>
                
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button 
                        id="startButton" 
                        class="bg-primary hover:bg-primary/90 text-white py-2 px-6 rounded-md text-base transition-all"
                        >Start Slideshow</button>
                    <button 
                        id="presenterButton" 
                        class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-6 rounded-md text-base transition-all"
                        >Presenter Mode</button>
                    <button 
                        id="saveButton" 
                        class="bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded-md text-base transition-all"
                        >Save to File</button>
                    <button 
                        id="loadButton" 
                        class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-md text-base transition-all"
                        >Load from File</button>
                    <button 
                        id="clearButton" 
                        class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 py-2 px-6 rounded-md text-base transition-all"
                        >Clear Lyrics</button>
                    <input type="file" id="fileInput" accept=".txt" class="hidden" />
                </div>
            </div>
        </div>
        
        <!-- Slideshow view -->
        <div id="slideshowView" class="h-full flex flex-col hidden">
            <div class="slideshow-container bg-black text-white flex-grow flex flex-col justify-center items-center relative" id="slideshowContainer">
                <div class="absolute top-4 left-4 flex space-x-2">
                    <button 
                        id="exitButton" 
                        class="bg-gray-800 hover:bg-gray-700 text-white py-1 px-3 rounded-md text-sm"
                        >Exit</button>
                    <button 
                        id="prevButton" 
                        class="bg-gray-800 hover:bg-gray-700 text-white py-1 px-3 rounded-md text-sm"
                        title="Go to previous slide"
                        >&larr; Back</button>
                    <button 
                        id="loadSongButton" 
                        class="bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded-md text-sm hidden"
                        title="Load new song"
                        >üìÅ Load Song</button>
                    <input type="file" id="presenterFileInput" accept=".txt" class="hidden" />
                </div>
                
                <div id="instructionText" class="text-center p-8 animate-fade-in">
                    <p class="text-xl mb-4">Click anywhere to advance through the lyrics</p>
                    <p class="text-gray-400">Current slide is shown in full, next slide is blurred</p>
                </div>
                
                <div id="lyricsDisplay" class="text-center p-8 hidden overflow-hidden">
                    <!-- Current lyrics (2 lines) -->
                    <div class="mb-8 lyrics-container slide-in-active">
                        <div id="currentLyric1" class="text-3xl md:text-4xl lg:text-5xl font-bold mb-4 min-h-[3rem] lyrics-line"></div>
                        <div id="currentLyric2" class="text-3xl md:text-4xl lg:text-5xl font-bold mb-4 min-h-[3rem] lyrics-line"></div>
                    </div>
                    
                    <!-- Next lyrics (2 lines, less blurred) -->
                    <div class="blur-text lyrics-container slide-in-active">
                        <div id="nextLyric1" class="text-xl md:text-2xl mb-2 min-h-[2rem] lyrics-line"></div>
                        <div id="nextLyric2" class="text-xl md:text-2xl mb-2 min-h-[2rem] lyrics-line"></div>
                    </div>
                </div>
                
                <!-- Songs Playlist Panel for Presenter Mode -->
                <div id="playlistPanel" class="absolute left-4 top-16 bottom-4 w-64 bg-gray-900 bg-opacity-90 rounded-lg p-4 hidden overflow-y-auto">
                    <h3 class="text-white text-lg font-bold mb-4 sticky top-0 bg-gray-900 pb-2">Playlist</h3>
                    <div class="mb-4">
                        <button id="addSongButton" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded text-sm">
                            + Add Song
                        </button>
                        <input type="file" id="playlistFileInput" accept=".txt" class="hidden" />
                    </div>
                    <div id="songsListContainer" class="space-y-2">
                        <!-- Songs will be populated here -->
                    </div>
                </div>
                
                <!-- Full Lyrics Panel for Presenter Mode -->
                <div id="fullLyricsPanel" class="absolute right-4 top-4 bottom-4 w-80 bg-gray-900 bg-opacity-90 rounded-lg p-4 hidden overflow-y-auto">
                    <h3 class="text-white text-lg font-bold mb-4 sticky top-0 bg-gray-900 pb-2">Current Song Lyrics</h3>
                    <div id="allLyricsContainer" class="space-y-1">
                        <!-- All lyrics will be populated here -->
                    </div>
                </div>
                
                <div class="absolute bottom-4 w-full flex justify-between px-6">
                    <div id="slideInfo" class="text-gray-400"></div>
                    <div class="text-gray-400">Tap/click to advance</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize dark mode based on user preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Get DOM elements
        const inputView = document.getElementById('inputView');
        const slideshowView = document.getElementById('slideshowView');
        const lyricsInput = document.getElementById('lyricsInput');
        const startButton = document.getElementById('startButton');
        const clearButton = document.getElementById('clearButton');
        const exitButton = document.getElementById('exitButton');
        const slideshowContainer = document.getElementById('slideshowContainer');
        const instructionText = document.getElementById('instructionText');
        const lyricsDisplay = document.getElementById('lyricsDisplay');
        const currentLyric1 = document.getElementById('currentLyric1');
        const currentLyric2 = document.getElementById('currentLyric2');
        const nextLyric1 = document.getElementById('nextLyric1');
        const nextLyric2 = document.getElementById('nextLyric2');
        const slideInfo = document.getElementById('slideInfo');
        
        let lyrics = [];
        let currentIndex = 0;
        
        // Event Listeners
        startButton.addEventListener('click', startSlideshow);
        clearButton.addEventListener('click', clearLyrics);
        exitButton.addEventListener('click', exitSlideshow);
        slideshowContainer.addEventListener('click', advanceSlide);
        
        // Get the previous button and add its event listener
        const prevButton = document.getElementById('prevButton');
        prevButton.addEventListener('click', goToPreviousSlide);
        
        // Get file handling elements and add event listeners
        const saveButton = document.getElementById('saveButton');
        const loadButton = document.getElementById('loadButton');
        const presenterButton = document.getElementById('presenterButton');
        const fileInput = document.getElementById('fileInput');
        
        saveButton.addEventListener('click', saveToFile);
        loadButton.addEventListener('click', () => fileInput.click());
        presenterButton.addEventListener('click', startPresenterMode);
        fileInput.addEventListener('change', loadFromFile);
        
        // Presenter mode variables
        let presenterWindow = null;
        let isPresenterMode = false;
        
        // Playlist variables
        let songPlaylist = [];
        let currentSongIndex = 0;
        
        // Try to load saved lyrics from localStorage if available
        try {
            const savedLyrics = localStorage.getItem('worshipLyrics');
            if (savedLyrics) {
                lyricsInput.value = savedLyrics;
            }
        } catch (e) {
            console.log('LocalStorage not available:', e);
        }
        
        function startSlideshow() {
            const text = lyricsInput.value.trim();
            if (!text) {
                alert('Please enter some lyrics first.');
                return;
            }
            
            // Try to save lyrics to localStorage
            try {
                localStorage.setItem('worshipLyrics', text);
            } catch (e) {
                console.log('Could not save to localStorage:', e);
            }
            
            // Split into lines and remove empty lines and section headers
            lyrics = text.split('\n')
                .map(line => line.trim())
                .filter(line => {
                    if (line.length === 0) return false;
                    
                    // Skip lines that start with verse, chorus, or bridge (case-insensitive)
                    const lowerLine = line.toLowerCase();
                    if (lowerLine.startsWith('verse') || 
                        lowerLine.startsWith('chorus') || 
                        lowerLine.startsWith('bridge')) {
                        return false;
                    }
                    
                    return true;
                });
            
            if (lyrics.length === 0) {
                alert('Please enter valid lyrics with at least one line.');
                return;
            }
            
            // Switch to slideshow view
            inputView.classList.add('hidden');
            slideshowView.classList.remove('hidden');
            
            // Reset and start slideshow
            currentIndex = 0;
            instructionText.classList.remove('hidden');
            lyricsDisplay.classList.add('hidden');
        }
        
        function advanceSlide() {
            // If first click, hide instructions and show lyrics
            if (!instructionText.classList.contains('hidden')) {
                instructionText.classList.add('hidden');
                lyricsDisplay.classList.remove('hidden');
                updateLyricDisplay();
                return;
            }
            
            // Advance to next slide (by 2 lines for natural flow)
            currentIndex += 2;
            
            // If we've reached the end, go back to start
            if (currentIndex >= lyrics.length) {
                currentIndex = 0;
            }
            
            updateLyricDisplay();
        }
        
        function updateLyricDisplay() {
            // Simple, immediate update - no animations
            currentLyric1.textContent = lyrics[currentIndex] || '';
            currentLyric2.textContent = lyrics[currentIndex + 1] || '';
            nextLyric1.textContent = lyrics[currentIndex + 2] || '';
            nextLyric2.textContent = lyrics[currentIndex + 3] || '';
            
            // Handle wrap-around for preview lines
            if (currentIndex + 2 >= lyrics.length) {
                nextLyric1.textContent = lyrics[(currentIndex + 2) % lyrics.length] || '';
            }
            if (currentIndex + 3 >= lyrics.length) {
                nextLyric2.textContent = lyrics[(currentIndex + 3) % lyrics.length] || '';
            }
            
            // Clean, clear styling
            currentLyric1.style.filter = 'none';
            currentLyric2.style.filter = 'none';
            currentLyric1.style.opacity = '1';
            currentLyric2.style.opacity = '1';
            
            nextLyric1.style.filter = 'blur(0.5px)';
            nextLyric2.style.filter = 'blur(0.5px)';
            nextLyric1.style.opacity = '0.7';
            nextLyric2.style.opacity = '0.7';
            
            // Update slide information
            const totalSlides = lyrics.length;
            const currentSlide = currentIndex + 1;
            slideInfo.textContent = `Line ${currentSlide} of ${totalSlides}`;
        }
        
        function clearLyrics() {
            lyricsInput.value = '';
            try {
                localStorage.removeItem('worshipLyrics');
            } catch (e) {
                console.log('Could not clear localStorage:', e);
            }
        }
        
        function exitSlideshow() {
            slideshowView.classList.add('hidden');
            inputView.classList.remove('hidden');
        }
        
        function goToPreviousSlide(event) {
            // Stop event propagation to prevent the main click handler from firing
            event.stopPropagation();
            
            // If we're still showing the instruction text, do nothing
            if (!instructionText.classList.contains('hidden')) {
                return;
            }
            
            // Go to the previous slide (by 2 lines for natural flow)
            currentIndex -= 2;
            
            // If we're before the first slide, loop to the end
            if (currentIndex < 0) {
                // Find the last valid 2-line starting position
                const totalSlides = Math.ceil(lyrics.length / 2);
                currentIndex = (totalSlides - 1) * 2;
            }
            
            updateLyricDisplay();
        }
        
        // Function to save the current lyrics to a text file
        function saveToFile() {
            const text = lyricsInput.value.trim();
            if (!text) {
                alert('Please enter some lyrics first before saving.');
                return;
            }
            
            // Create an invisible link element
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            // Create a link to download the file
            const a = document.createElement('a');
            a.href = url;
            
            // Get song title from first non-empty line or use default
            let firstLine = text.split('\n').find(line => line.trim().length > 0) || '';
            // Clean up the title: remove section markers and limit length
            firstLine = firstLine.replace(/^(verse|chorus|bridge)\s*\d*/i, '').trim();
            const fileName = firstLine.slice(0, 30).trim() || 'worship-lyrics';
            
            a.download = `${fileName}.txt`;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show success message
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Saved!';
            setTimeout(() => {
                saveButton.textContent = originalText;
            }, 1500);
        }
        
        // Function to load lyrics from a text file
        function loadFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                lyricsInput.value = e.target.result;
                
                // Save to localStorage
                try {
                    localStorage.setItem('worshipLyrics', e.target.result);
                } catch (err) {
                    console.log('Could not save to localStorage:', err);
                }
                
                // Show success message
                const originalText = loadButton.textContent;
                loadButton.textContent = 'Loaded!';
                setTimeout(() => {
                    loadButton.textContent = originalText;
                }, 1500);
            };
            
            reader.readAsText(file);
            
            // Reset the file input so the same file can be loaded again
            fileInput.value = '';
        }
        
        // Presenter Mode Functions
        function startPresenterMode() {
            const text = lyricsInput.value.trim();
            if (!text) {
                alert('Please enter some lyrics first.');
                return;
            }
            
            // Process lyrics same as regular slideshow
            try {
                localStorage.setItem('worshipLyrics', text);
            } catch (e) {
                console.log('Could not save to localStorage:', e);
            }
            
            lyrics = text.split('\n')
                .map(line => line.trim())
                .filter(line => {
                    if (line.length === 0) return false;
                    const lowerLine = line.toLowerCase();
                    if (lowerLine.startsWith('verse') || 
                        lowerLine.startsWith('chorus') || 
                        lowerLine.startsWith('bridge')) {
                        return false;
                    }
                    return true;
                });
            
            if (lyrics.length === 0) {
                alert('Please enter valid lyrics with at least one line.');
                return;
            }
            
            // Open presenter window
            const presenterHTML = createPresenterWindowHTML();
            presenterWindow = window.open('', 'PresenterWindow', 'width=800,height=600,menubar=no,toolbar=no,location=no,status=no,scrollbars=no');
            
            if (!presenterWindow) {
                alert('Please allow pop-ups for this site to use Presenter Mode.');
                return;
            }
            
            presenterWindow.document.write(presenterHTML);
            presenterWindow.document.close();
            
            // Initialize presenter mode
            currentIndex = 0;
            isPresenterMode = true;
            
            // Switch to presenter control view
            inputView.classList.add('hidden');
            slideshowView.classList.remove('hidden');
            
            // Update button text
            presenterButton.textContent = 'Exit Presenter Mode';
            presenterButton.onclick = exitPresenterMode;
            
            // Update presenter window
            updatePresenterWindow();
            
            // Show instructions
            instructionText.innerHTML = `
                <p class="text-xl mb-4">Presenter Mode Active</p>
                <p class="text-gray-400">Move the popup window to your second monitor</p>
                <p class="text-gray-400">Click here or use buttons to control the presentation</p>
            `;
            
            // Show the load song button in presenter mode
            const loadSongButton = document.getElementById('loadSongButton');
            const presenterFileInput = document.getElementById('presenterFileInput');
            loadSongButton.classList.remove('hidden');
            
            // Show playlist and full lyrics panels
            const playlistPanel = document.getElementById('playlistPanel');
            const fullLyricsPanel = document.getElementById('fullLyricsPanel');
            playlistPanel.classList.remove('hidden');
            fullLyricsPanel.classList.remove('hidden');
            
            // Add current song to playlist if not already there
            addCurrentSongToPlaylist();
            
            // Populate panels
            populatePlaylist();
            populateFullLyricsPanel();
            
            // Add playlist event listeners
            const addSongButton = document.getElementById('addSongButton');
            const playlistFileInput = document.getElementById('playlistFileInput');
            addSongButton.addEventListener('click', () => playlistFileInput.click());
            playlistFileInput.addEventListener('change', addSongToPlaylist);
            
            // Add event listeners for song loading during presentation
            loadSongButton.addEventListener('click', () => presenterFileInput.click());
            presenterFileInput.addEventListener('change', loadSongDuringPresentation);
        }
        
        function createPresenterWindowHTML() {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Worship Lyrics - Presentation</title>
                    <style>
                        body {
                            margin: 0;
                            background: black;
                            color: white;
                            font-family: Arial, sans-serif;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            align-items: center;
                            min-height: 100vh;
                            padding: 40px;
                            text-align: center;
                        }
                        .current-lyrics {
                            margin-bottom: 60px;
                        }
                        .current-line {
                            font-size: 4rem;
                            font-weight: bold;
                            margin-bottom: 30px;
                            line-height: 1.2;
                        }
                        .preview-lyrics {
                            opacity: 0.7;
                            filter: blur(0.5px);
                        }
                        .preview-line {
                            font-size: 2rem;
                            margin-bottom: 15px;
                            line-height: 1.3;
                        }
                        @media (max-width: 1200px) {
                            .current-line { font-size: 3rem; }
                            .preview-line { font-size: 1.5rem; }
                        }
                        @media (max-width: 800px) {
                            .current-line { font-size: 2rem; }
                            .preview-line { font-size: 1.2rem; }
                        }
                    </style>
                </head>
                <body>
                    <div class="current-lyrics">
                        <div id="presenterCurrent1" class="current-line"></div>
                        <div id="presenterCurrent2" class="current-line"></div>
                    </div>
                    <div class="preview-lyrics">
                        <div id="presenterNext1" class="preview-line"></div>
                        <div id="presenterNext2" class="preview-line"></div>
                    </div>
                </body>
                </html>
            `;
        }
        
        function updatePresenterWindow() {
            if (!presenterWindow || presenterWindow.closed) {
                exitPresenterMode();
                return;
            }
            
            const doc = presenterWindow.document;
            const current1 = doc.getElementById('presenterCurrent1');
            const current2 = doc.getElementById('presenterCurrent2');
            const next1 = doc.getElementById('presenterNext1');
            const next2 = doc.getElementById('presenterNext2');
            
            if (current1 && current2 && next1 && next2) {
                current1.textContent = lyrics[currentIndex] || '';
                current2.textContent = lyrics[currentIndex + 1] || '';
                next1.textContent = lyrics[currentIndex + 2] || '';
                next2.textContent = lyrics[currentIndex + 3] || '';
                
                // Handle wrap-around
                if (currentIndex + 2 >= lyrics.length) {
                    next1.textContent = lyrics[(currentIndex + 2) % lyrics.length] || '';
                }
                if (currentIndex + 3 >= lyrics.length) {
                    next2.textContent = lyrics[(currentIndex + 3) % lyrics.length] || '';
                }
            }
            
            // Also update the control view
            updateLyricDisplay();
        }
        
        function exitPresenterMode() {
            isPresenterMode = false;
            
            if (presenterWindow && !presenterWindow.closed) {
                presenterWindow.close();
            }
            presenterWindow = null;
            
            // Reset button
            presenterButton.textContent = 'Presenter Mode';
            presenterButton.onclick = startPresenterMode;
            
            // Return to input view
            exitSlideshow();
        }
        
        // Fix the advance and back functions for presenter mode
        function advanceSlideFinal() {
            // If first click, hide instructions and show lyrics
            if (!instructionText.classList.contains('hidden')) {
                instructionText.classList.add('hidden');
                lyricsDisplay.classList.remove('hidden');
                updateLyricDisplayFinal();
                return;
            }
            
            // Advance to next slide (by 2 lines for natural flow)
            currentIndex += 2;
            
            // If we've reached the end, go back to start
            if (currentIndex >= lyrics.length) {
                currentIndex = 0;
            }
            
            updateLyricDisplayFinal();
        }
        
        function goToPreviousSlideFinal(event) {
            // Stop event propagation to prevent the main click handler from firing
            event.stopPropagation();
            
            // If we're still showing the instruction text, do nothing
            if (!instructionText.classList.contains('hidden')) {
                return;
            }
            
            // Go to the previous slide (by 2 lines for natural flow)
            currentIndex -= 2;
            
            // If we're before the first slide, loop to the end
            if (currentIndex < 0) {
                // Find the last valid 2-line starting position
                const totalSlides = Math.ceil(lyrics.length / 2);
                currentIndex = (totalSlides - 1) * 2;
            }
            
            updateLyricDisplayFinal();
        }
        
        function updateLyricDisplayFinal() {
            // Update main display
            updateLyricDisplay();
            
            // Update presenter window if active
            if (isPresenterMode) {
                updatePresenterWindow();
            }
        }
        
        // Function to load a new song during presentation
        function loadSongDuringPresentation(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result.trim();
                
                // Process the new lyrics
                lyrics = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => {
                        if (line.length === 0) return false;
                        const lowerLine = line.toLowerCase();
                        if (lowerLine.startsWith('verse') || 
                            lowerLine.startsWith('chorus') || 
                            lowerLine.startsWith('bridge')) {
                            return false;
                        }
                        return true;
                    });
                
                if (lyrics.length === 0) {
                    alert('No valid lyrics found in the file.');
                    return;
                }
                
                // Reset to start of new song
                currentIndex = 0;
                
                // Update both displays immediately
                updateLyricDisplayFinal();
                
                // Show success message briefly
                const originalInstructions = instructionText.innerHTML;
                instructionText.innerHTML = `
                    <p class="text-xl mb-4 text-green-400">New Song Loaded!</p>
                    <p class="text-gray-400">Click to start the new song</p>
                `;
                
                setTimeout(() => {
                    instructionText.innerHTML = originalInstructions;
                }, 2000);
            };
            
            reader.readAsText(file);
            
            // Reset the file input
            event.target.value = '';
        }
        
        // Full Lyrics Panel Functions
        function populateFullLyricsPanel() {
            const allLyricsContainer = document.getElementById('allLyricsContainer');
            allLyricsContainer.innerHTML = '';
            
            // Group lyrics into pairs for display
            for (let i = 0; i < lyrics.length; i += 2) {
                const pairDiv = document.createElement('div');
                pairDiv.className = 'lyrics-pair cursor-pointer p-2 rounded transition-all hover:bg-gray-700';
                pairDiv.dataset.index = i;
                
                const line1 = document.createElement('div');
                line1.className = 'text-white text-sm pointer-events-none';
                line1.textContent = lyrics[i] || '';
                
                const line2 = document.createElement('div');
                line2.className = 'text-gray-300 text-sm pointer-events-none';
                line2.textContent = lyrics[i + 1] || '';
                
                pairDiv.appendChild(line1);
                if (lyrics[i + 1]) {
                    pairDiv.appendChild(line2);
                }
                
                // Add click handler to jump to this section with proper closure
                pairDiv.addEventListener('click', (function(index) {
                    return function(event) {
                        event.stopPropagation();
                        jumpToLyricPair(index);
                    };
                })(i));
                
                allLyricsContainer.appendChild(pairDiv);
            }
            
            // Highlight current position
            updateFullLyricsHighlight();
        }
        
        function updateFullLyricsHighlight() {
            if (!isPresenterMode) return;
            
            const allPairs = document.querySelectorAll('.lyrics-pair');
            
            // Remove highlighting from all pairs
            allPairs.forEach(pair => {
                pair.classList.remove('bg-primary', 'bg-gray-700');
                pair.classList.add('hover:bg-gray-700');
            });
            
            // Highlight current pair
            const currentPairIndex = Math.floor(currentIndex / 2);
            if (allPairs[currentPairIndex]) {
                allPairs[currentPairIndex].classList.add('bg-primary');
                allPairs[currentPairIndex].classList.remove('hover:bg-gray-700');
                
                // Scroll current pair into view
                allPairs[currentPairIndex].scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }
        
        function jumpToLyricPair(index) {
            currentIndex = index;
            updateLyricDisplayFinal();
            updateFullLyricsHighlight();
        }
        
        // Update the updateLyricDisplayFinal function to include full lyrics highlighting
        const originalUpdateLyricDisplayFinal = updateLyricDisplayFinal;
        updateLyricDisplayFinal = function() {
            originalUpdateLyricDisplayFinal();
            if (isPresenterMode) {
                updateFullLyricsHighlight();
            }
        };
        
        // Update populateFullLyricsPanel when loading new songs
        const originalLoadSongDuringPresentation = loadSongDuringPresentation;
        loadSongDuringPresentation = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result.trim();
                
                // Process the new lyrics
                lyrics = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => {
                        if (line.length === 0) return false;
                        const lowerLine = line.toLowerCase();
                        if (lowerLine.startsWith('verse') || 
                            lowerLine.startsWith('chorus') || 
                            lowerLine.startsWith('bridge')) {
                            return false;
                        }
                        return true;
                    });
                
                if (lyrics.length === 0) {
                    alert('No valid lyrics found in the file.');
                    return;
                }
                
                // Reset to start of new song
                currentIndex = 0;
                
                // Re-populate the full lyrics panel
                populateFullLyricsPanel();
                
                // Update both displays immediately
                updateLyricDisplayFinal();
                
                // Show success message briefly
                const originalInstructions = instructionText.innerHTML;
                instructionText.innerHTML = `
                    <p class="text-xl mb-4 text-green-400">New Song Loaded!</p>
                    <p class="text-gray-400">Click to start the new song</p>
                `;
                
                setTimeout(() => {
                    instructionText.innerHTML = originalInstructions;
                }, 2000);
            };
            
            reader.readAsText(file);
            
            // Reset the file input
            event.target.value = '';
        };
        
        // Keyboard Navigation
        function handleKeyboardNavigation(event) {
            // Only handle keyboard navigation when slideshow is active
            if (slideshowView.classList.contains('hidden')) {
                return;
            }
            
            // If instruction text is still showing, any key starts the slideshow
            if (!instructionText.classList.contains('hidden')) {
                if (event.key === 'ArrowRight' || event.key === 'ArrowLeft' || event.key === ' ') {
                    event.preventDefault();
                    instructionText.classList.add('hidden');
                    lyricsDisplay.classList.remove('hidden');
                    updateLyricDisplayFinal();
                }
                return;
            }
            
            // Handle navigation keys
            switch(event.key) {
                case 'ArrowRight':
                case ' ': // Spacebar
                    event.preventDefault();
                    // Advance to next slide (by 2 lines for natural flow)
                    currentIndex += 2;
                    
                    // If we've reached the end, go back to start
                    if (currentIndex >= lyrics.length) {
                        currentIndex = 0;
                    }
                    
                    updateLyricDisplayFinal();
                    break;
                    
                case 'ArrowLeft':
                    event.preventDefault();
                    // Go to the previous slide (by 2 lines for natural flow)
                    currentIndex -= 2;
                    
                    // If we're before the first slide, loop to the end
                    if (currentIndex < 0) {
                        // Find the last valid 2-line starting position
                        const totalSlides = Math.ceil(lyrics.length / 2);
                        currentIndex = (totalSlides - 1) * 2;
                    }
                    
                    updateLyricDisplayFinal();
                    break;
                    
                case 'Escape':
                    event.preventDefault();
                    if (isPresenterMode) {
                        exitPresenterMode();
                    } else {
                        exitSlideshow();
                    }
                    break;
            }
        }
        
        // Playlist Management Functions
        function addCurrentSongToPlaylist() {
            if (lyrics.length === 0) return;
            
            // Get song title from first line
            const songTitle = getSongTitle(lyrics);
            
            // Check if song already exists in playlist
            const existingIndex = songPlaylist.findIndex(song => song.title === songTitle);
            
            if (existingIndex === -1) {
                // Add new song to playlist
                songPlaylist.push({
                    title: songTitle,
                    lyrics: [...lyrics],
                    id: Date.now()
                });
                currentSongIndex = songPlaylist.length - 1;
            } else {
                // Update existing song
                songPlaylist[existingIndex].lyrics = [...lyrics];
                currentSongIndex = existingIndex;
            }
        }
        
        function addSongToPlaylist(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (songPlaylist.length >= 10) {
                alert('Maximum 10 songs allowed in playlist. Please remove a song first.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result.trim();
                
                // Process the new lyrics
                const newLyrics = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => {
                        if (line.length === 0) return false;
                        const lowerLine = line.toLowerCase();
                        if (lowerLine.startsWith('verse') || 
                            lowerLine.startsWith('chorus') || 
                            lowerLine.startsWith('bridge')) {
                            return false;
                        }
                        return true;
                    });
                
                if (newLyrics.length === 0) {
                    alert('No valid lyrics found in the file.');
                    return;
                }
                
                // Get song title from filename (remove extension)
                const songTitle = file.name.replace(/\.[^/.]+$/, "");
                
                // Add to playlist
                songPlaylist.push({
                    title: songTitle,
                    lyrics: newLyrics,
                    id: Date.now(),
                    filename: file.name
                });
                
                // Refresh playlist display
                populatePlaylist();
                
                // Show success message
                const originalText = addSongButton.textContent;
                addSongButton.textContent = 'Added!';
                setTimeout(() => {
                    addSongButton.textContent = '+ Add Song';
                }, 1500);
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function getSongTitle(lyricsArray) {
            if (lyricsArray.length === 0) return 'Untitled Song';
            
            let title = lyricsArray[0];
            // Clean up the title
            title = title.replace(/^(verse|chorus|bridge)\s*\d*/i, '').trim();
            // Limit length
            return title.slice(0, 25) || 'Untitled Song';
        }
        
        function populatePlaylist() {
            const songsListContainer = document.getElementById('songsListContainer');
            songsListContainer.innerHTML = '';
            
            if (songPlaylist.length === 0) {
                songsListContainer.innerHTML = '<p class="text-gray-400 text-sm">No songs in playlist</p>';
                return;
            }
            
            songPlaylist.forEach((song, index) => {
                const songDiv = document.createElement('div');
                songDiv.className = `song-item cursor-pointer p-2 rounded transition-all hover:bg-gray-700 ${index === currentSongIndex ? 'bg-primary' : 'bg-gray-800'}`;
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'text-white text-sm font-medium pointer-events-none';
                titleDiv.textContent = song.title;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'text-gray-400 text-xs pointer-events-none';
                infoDiv.textContent = `${song.lyrics.length} lines`;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-400 hover:text-red-300 text-xs mt-1';
                deleteBtn.textContent = '√ó Remove';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeSongFromPlaylist(index);
                });
                
                songDiv.appendChild(titleDiv);
                songDiv.appendChild(infoDiv);
                songDiv.appendChild(deleteBtn);
                
                // Add click handler to switch to this song
                songDiv.addEventListener('click', () => switchToSong(index));
                
                songsListContainer.appendChild(songDiv);
            });
        }
        
        function switchToSong(index) {
            if (index < 0 || index >= songPlaylist.length) return;
            
            currentSongIndex = index;
            lyrics = [...songPlaylist[index].lyrics];
            currentIndex = 0;
            
            // Update all displays
            populatePlaylist();
            populateFullLyricsPanel();
            updateLyricDisplayFinal();
            
            // Show song switch message
            const originalInstructions = instructionText.innerHTML;
            instructionText.innerHTML = `
                <p class="text-xl mb-4 text-blue-400">Switched to: ${songPlaylist[index].title}</p>
                <p class="text-gray-400">Click to start this song</p>
            `;
            
            setTimeout(() => {
                instructionText.innerHTML = originalInstructions;
            }, 2000);
        }
        
        function removeSongFromPlaylist(index) {
            if (index < 0 || index >= songPlaylist.length) return;
            
            songPlaylist.splice(index, 1);
            
            // Adjust currentSongIndex if needed
            if (currentSongIndex >= index && currentSongIndex > 0) {
                currentSongIndex--;
            }
            
            // If we removed the current song and there are others, switch to the first one
            if (songPlaylist.length > 0) {
                if (currentSongIndex >= songPlaylist.length) {
                    currentSongIndex = 0;
                }
                switchToSong(currentSongIndex);
            } else {
                // No songs left
                populatePlaylist();
            }
        }
        
        // Add keyboard event listener
        document.addEventListener('keydown', handleKeyboardNavigation);
        
        // Replace the event handlers
        slideshowContainer.removeEventListener('click', advanceSlide);
        prevButton.removeEventListener('click', goToPreviousSlide);
        slideshowContainer.addEventListener('click', advanceSlideFinal);
        prevButton.addEventListener('click', goToPreviousSlideFinal);
    </script>
</body>
</html>